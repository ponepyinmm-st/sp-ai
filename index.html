<!DOCTYPE html>
<html lang="my">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Floor Plan Generator (GF Support)</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Myanmar:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Noto Sans Myanmar', sans-serif; background-color: #e5e7eb; }
        
        /* THE MAIN CANVAS (500x1350) - Fixed Ratio */
        .canvas-container {
            width: 500px;
            height: 1350px;
            background: white;
            margin: 0 auto;
            box-shadow: 0 0 20px rgba(0,0,0,0.2);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            border: 1px solid #ccc;
        }

        /* Header Area */
        .canvas-header {
            background-color: #b91c1c; /* Dark Red */
            color: white;
            padding: 25px;
            text-align: center;
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        /* Grid Body - Stretches to fill height */
        .grid-body {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 20px;
            background-color: #fff;
            justify-content: space-evenly; 
        }

        /* Each Floor Row */
        .floor-row {
            flex: 1; 
            display: flex;
            align-items: stretch;
            margin-bottom: 10px;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            overflow: hidden;
            max-height: 160px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .floor-label {
            width: 90px;
            background-color: #f1f5f9;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 800; /* Bolder font for GF */
            color: #334155;
            font-size: 20px;
            border-right: 1px solid #cbd5e1;
        }

        .units-container {
            flex: 1;
            display: flex;
            padding: 8px;
            gap: 10px;
            background: white;
        }

        .unit-cell {
            flex: 1;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border: 3px solid; 
            transition: all 0.2s;
            position: relative;
        }

        /* STATUS COLORS */
        .status-available { border-color: #22c55e; background-color: #f0fdf4; color: #15803d; }
        .status-sold { border-color: #ef4444; background-color: #fee2e2; color: #ef4444; }
        .status-reserved { border-color: #eab308; background-color: #fef9c3; color: #854d0e; }
        
        .status-hidden { 
            border-color: #e5e7eb; 
            background-color: #f9fafb; 
            opacity: 0.3; 
            border-style: dashed;
        }

        .price-text {
            font-weight: 800;
            font-size: 18px;
            color: #b91c1c;
            background: white;
            padding: 4px 10px;
            border-radius: 6px;
            margin-bottom: 6px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .status-text {
            font-size: 16px;
            font-weight: 600;
        }
        
        /* Footer */
        .canvas-footer {
            padding: 15px;
            text-align: center;
            background: #f8fafc;
            color: #94a3b8;
            font-size: 12px;
            border-top: 1px solid #e2e8f0;
            flex-shrink: 0;
        }
    </style>
</head>
<body class="p-4 flex flex-col items-center">
    
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- Helper: Fetch ---
        async function fetchWithRetry(url, options, retries = 2, backoff = 1000) {
            try {
                const response = await fetch(url, options);
                if (!response.ok) {
                    const errorText = await response.text();
                    if (retries > 0) {
                        await new Promise(r => setTimeout(r, backoff));
                        return fetchWithRetry(url, options, retries - 1, backoff * 2);
                    }
                    throw new Error(`Server Error: ${response.status}`);
                }
                return response;
            } catch (err) {
                if (retries > 0) {
                    await new Promise(r => setTimeout(r, backoff));
                    return fetchWithRetry(url, options, retries - 1, backoff * 2);
                }
                throw err;
            }
        }

        const cleanJsonString = (str) => {
            if (!str) return '{}';
            try {
                const match = str.match(/\{[\s\S]*\}/);
                return match ? match[0] : str;
            } catch (e) { return str; }
        };

        function App() {
            const [chartImagePreview, setChartImagePreview] = useState(null);
            const [rawText, setRawText] = useState('');
            const [isAnalyzing, setIsAnalyzing] = useState(false);
            const [error, setError] = useState('');
            
            // UI Mode: 'status' or 'price'
            const [editMode, setEditMode] = useState('status');

            // Grid Data
            const [floorConfig, setFloorConfig] = useState({ floors: 6, unitsPerFloor: 2 });
            const [floorUnits, setFloorUnits] = useState({});

            // PASTE EVENT LISTENER
            useEffect(() => {
                const handlePaste = (e) => {
                    const items = e.clipboardData.items;
                    for (let i = 0; i < items.length; i++) {
                        if (items[i].type.indexOf('image') !== -1) {
                            const blob = items[i].getAsFile();
                            const reader = new FileReader();
                            reader.onload = (event) => {
                                setChartImagePreview(event.target.result);
                                // Optional: Auto analyze on paste? 
                                // analyzeData(event.target.result, rawText); 
                            };
                            reader.readAsDataURL(blob);
                        }
                    }
                };
                window.addEventListener('paste', handlePaste);
                return () => window.removeEventListener('paste', handlePaste);
            }, [rawText]);

            // Initialize Grid
            useEffect(() => {
                const newUnits = {};
                for (let f = 1; f <= floorConfig.floors; f++) {
                    for (let u = 1; u <= floorConfig.unitsPerFloor; u++) {
                        const id = `${f}-${u}`;
                        if (floorUnits[id]) newUnits[id] = floorUnits[id];
                        else newUnits[id] = { id, floor: f, unit: u, status: 'available', price: '' };
                    }
                }
                setFloorUnits(newUnits);
            }, [floorConfig.floors, floorConfig.unitsPerFloor]);

            const handleChartUpload = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onloadend = () => {
                        setChartImagePreview(reader.result);
                    };
                    reader.readAsDataURL(file);
                }
            };

            const handleDownloadImage = async () => {
                const element = document.getElementById('canvas-export');
                if (!element) return;
                
                try {
                    const canvas = await html2canvas(element, { scale: 2, useCORS: true });
                    const link = document.createElement('a');
                    link.download = `floor-plan-${Date.now()}.png`;
                    link.href = canvas.toDataURL();
                    link.click();
                } catch (err) {
                    alert("Image save failed: " + err.message);
                }
            };

            // HANDLE CLICK BASED ON MODE
            const handleUnitClick = (id) => {
                if (editMode === 'status') {
                    // Toggle Status
                    setFloorUnits(prev => {
                        const current = prev[id];
                        let nextStatus = 'sold';
                        if (current.status === 'available') nextStatus = 'sold';
                        else if (current.status === 'sold') nextStatus = 'reserved';
                        else if (current.status === 'reserved') nextStatus = 'hidden';
                        else if (current.status === 'hidden') nextStatus = 'available';
                        return { ...prev, [id]: { ...current, status: nextStatus }};
                    });
                } else {
                    // Edit Price
                    const currentUnit = floorUnits[id];
                    const newPrice = prompt("·Äà·Ä±·Ä∏·Äî·Äæ·ÄØ·Äî·Ä∫·Ä∏ ·Ä°·Äû·ÄÖ·Ä∫·Äë·Ää·Ä∑·Ä∫·Äï·Ä´ (·Ä•·Äï·Äô·Ä¨ - ·ÅÅ·ÅÖ·ÅÄ·ÅÄ):", currentUnit?.price || "");
                    if (newPrice !== null) {
                        setFloorUnits(prev => ({
                            ...prev,
                            [id]: { ...prev[id], price: newPrice }
                        }));
                    }
                }
            };

            const analyzeData = async () => {
                if (!chartImagePreview && !rawText.trim()) {
                    setError("Please upload an image OR enter text.");
                    return;
                }

                setIsAnalyzing(true);
                setError('');
                try {
                    let promptParts = [];
                    
                    if (rawText.trim()) {
                        promptParts.push({ text: `Analyze this Text Description:\n${rawText}` });
                    }

                    if (chartImagePreview) {
                        const base64Content = chartImagePreview.split(',')[1];
                        const mimeType = chartImagePreview.substring(chartImagePreview.indexOf(":") + 1, chartImagePreview.indexOf(";"));
                        promptParts.push({ text: "Also analyze this Image:" });
                        promptParts.push({ inlineData: { mimeType: mimeType, data: base64Content } });
                    }
                    
                    const systemPrompt = `
                        You are a Real Estate Data Extractor.
                        
                        **MAPPING RULES:**
                        1. **Internal Logic:** Text/Image "Ground floor" or "GFL" is Floor 1 internally. "First floor" is Floor 2 internally.
                           - "·Äô·Äº·Ä±·Äõ·Äæ·ÄÑ·Ä∫" (Landowner) -> Status: "sold".
                           - "Sold" / "X" -> Status: "sold".
                           - Prices (e.g., "2500") -> Status: "available", Price: "2500".
                        2. **Visual Stack:** Bottom is Floor 1 (GF).
                        3. **PENTHOUSE:** If top floors have fewer units, mark empty as "hidden".

                        **TASK:**
                        Return JSON: { "floors": n, "unitsPerFloor": n, "units": [{"floor":n, "unit":n, "status":"sold"|"available"|"reserved"|"hidden", "price": "string"}] }
                    `;

                    const payload = {
                        contents: [{ parts: [...promptParts, { text: systemPrompt }] }],
                        generationConfig: { responseMimeType: "application/json" }
                    };

                    const response = await fetchWithRetry('/api/generate', { 
                        method: 'POST', 
                        headers: { 'Content-Type': 'application/json' }, 
                        body: JSON.stringify(payload) 
                    });
                    
                    const data = await response.json();
                    if (!data.candidates) throw new Error("AI analysis failed.");
                    
                    const result = JSON.parse(cleanJsonString(data.candidates[0].content.parts[0].text));

                    if (result.floors) {
                        const finalUnitsPerFloor = result.unitsPerFloor || 1;
                        setFloorConfig({ floors: result.floors, unitsPerFloor: finalUnitsPerFloor });
                        
                        const newUnits = {};
                        for (let f = 1; f <= result.floors; f++) {
                            for (let u = 1; u <= finalUnitsPerFloor; u++) {
                                newUnits[`${f}-${u}`] = { id: `${f}-${u}`, floor: f, unit: u, status: 'available', price: '' };
                            }
                        }
                        if (result.units) {
                            result.units.forEach(u => {
                                let mapFloor = u.floor === 0 ? 1 : u.floor;
                                if (mapFloor > result.floors) mapFloor = result.floors;
                                const id = `${mapFloor}-${u.unit}`;
                                if (newUnits[id]) {
                                    newUnits[id].status = u.status;
                                    if (u.price) newUnits[id].price = u.price;
                                }
                            });
                        }
                        setFloorUnits(newUnits);
                    }
                } catch (err) { 
                    console.error(err); 
                    setError('Error: ' + err.message); 
                } 
                finally { setIsAnalyzing(false); }
            };

            const gridFloors = useMemo(() => {
                const floors = [];
                for(let f = floorConfig.floors; f >= 1; f--) floors.push(f);
                return floors;
            }, [floorConfig.floors]);

            return (
                <div className="flex flex-col gap-6 items-center w-full">
                    
                    {/* Controls */}
                    <div className="bg-white p-4 rounded-xl shadow w-full max-w-[500px] border border-gray-200 mt-4">
                        <h1 className="text-xl font-bold text-gray-800 mb-4 text-center">Floor Plan Generator</h1>
                        
                        {/* INPUT SECTION */}
                        <div className="space-y-4 mb-4">
                            {/* Text Input */}
                            <div>
                                <label className="text-xs font-bold text-gray-500 uppercase">·ÄÖ·Ä¨·Äû·Ä¨·Ä∏·Äñ·Äº·ÄÑ·Ä∑·Ä∫ ·Äë·Ää·Ä∑·Ä∫·Äõ·Äî·Ä∫ (Optional)</label>
                                <textarea 
                                    className="w-full border p-2 rounded text-sm h-20 focus:border-blue-500 outline-none" 
                                    placeholder="Example: Ground floor - ·Äô·Äº·Ä±·Äõ·Äæ·ÄÑ·Ä∫, 1st Floor - 2500..."
                                    value={rawText}
                                    onChange={(e) => setRawText(e.target.value)}
                                ></textarea>
                            </div>

                            {/* Image Input / Paste Area */}
                            <label className="flex flex-col items-center justify-center w-full h-24 border-2 border-dashed border-blue-300 rounded-lg cursor-pointer hover:bg-blue-50 transition bg-gray-50 relative">
                                {isAnalyzing ? (
                                    <div className="animate-pulse text-blue-600 font-bold text-sm">AI ·Äñ·Äê·Ä∫·Äî·Ä±·Äï·Ä´·Äû·Ää·Ä∫...</div>
                                ) : (
                                    chartImagePreview ? <div className="text-green-600 font-bold text-sm">Image Loaded (Click to Change)</div> : 
                                    <div className="text-center">
                                        <span className="text-gray-500 text-sm font-bold block">Screenshot ·Äê·ÄÑ·Ä∫·Äõ·Äî·Ä∫ (·Äû·Ä≠·ÄØ·Ä∑)</span>
                                        <span className="text-blue-500 text-xs font-bold bg-blue-100 px-2 py-1 rounded mt-1 inline-block">Ctrl + V ·Äî·Äæ·Ä≠·Äï·Ä∫·Äï·Äº·ÄÆ·Ä∏ Paste ·Äï·Ä´</span>
                                    </div>
                                )}
                                <input type="file" className="hidden" accept="image/*" onChange={handleChartUpload} disabled={isAnalyzing} />
                            </label>

                            <button 
                                onClick={analyzeData}
                                disabled={isAnalyzing}
                                className="w-full bg-[#e30147] text-white py-2 rounded-lg font-bold shadow hover:bg-red-700 transition"
                            >
                                {isAnalyzing ? 'Processing...' : 'Generate Plan üöÄ'}
                            </button>
                        </div>

                        {/* EDIT MODE TOGGLE */}
                        <div className="flex bg-gray-100 p-1 rounded-lg mb-4">
                            <button className={`flex-1 py-2 rounded-md text-sm font-bold transition-all ${editMode === 'status' ? 'bg-white shadow text-blue-600' : 'text-gray-500'}`} onClick={() => setEditMode('status')}>üîÑ Status</button>
                            <button className={`flex-1 py-2 rounded-md text-sm font-bold transition-all ${editMode === 'price' ? 'bg-white shadow text-red-600' : 'text-gray-500'}`} onClick={() => setEditMode('price')}>‚úèÔ∏è Price</button>
                        </div>

                        {/* Manual Config */}
                         <div className="flex gap-4">
                            <div className="w-1/2">
                                <label className="text-[10px] text-gray-400 uppercase font-bold">·Ä°·Äë·Äï·Ä∫</label>
                                <input type="number" value={floorConfig.floors} onChange={(e) => setFloorConfig({...floorConfig, floors: +e.target.value})} className="w-full border p-2 rounded text-sm" />
                            </div>
                            <div className="w-1/2">
                                <label className="text-[10px] text-gray-400 uppercase font-bold">·Ä°·ÄÅ·Äî·Ä∫·Ä∏</label>
                                <input type="number" value={floorConfig.unitsPerFloor} onChange={(e) => setFloorConfig({...floorConfig, unitsPerFloor: +e.target.value})} className="w-full border p-2 rounded text-sm" />
                            </div>
                        </div>
                        {error && <div className="mt-2 text-red-600 text-xs">{error}</div>}
                    </div>

                    {/* --- CANVAS 500x1350 --- */}
                    <div id="canvas-export" className="canvas-container">
                        <div className="canvas-header">
                            <h2 className="text-3xl font-bold tracking-wide uppercase">Floor Plan & Prices</h2>
                        </div>
                        
                        <div className="grid-body">
                            {gridFloors.map(f => (
                                <div key={f} className="floor-row">
                                    {/* --- UPDATED LABEL LOGIC: 1=GF, 2=1·Äú·ÄΩ·Äæ·Ä¨... --- */}
                                    <div className="floor-label">{f === 1 ? 'GF' : `${f-1} ·Äú·ÄΩ·Äæ·Ä¨`}</div>
                                    
                                    <div className="units-container">
                                        {Array.from({length: floorConfig.unitsPerFloor}).map((_, i) => {
                                            const u = i + 1;
                                            const id = `${f}-${u}`;
                                            const unit = floorUnits[id] || {status: 'available'};
                                            
                                            let statusClass = 'status-available';
                                            let label = '·Äõ·Ä±·Ä¨·ÄÑ·Ä∫·Ä∏·Äõ·Äî·Ä∫';
                                            
                                            if (unit.status === 'sold') { 
                                                statusClass = 'status-sold'; 
                                                label = '·Äõ·Ä±·Ä¨·ÄÑ·Ä∫·Ä∏·Äï·Äº·ÄÆ·Ä∏'; 
                                            }
                                            else if (unit.status === 'reserved') { 
                                                statusClass = 'status-reserved'; 
                                                label = '·ÄÖ·Ä¨·Äõ·ÄÑ·Ä∫·Ä∏·Äû·ÄΩ·ÄÑ·Ä∫·Ä∏'; 
                                            }
                                            else if (unit.status === 'hidden') { 
                                                statusClass = 'status-hidden'; 
                                                label = ''; 
                                            }

                                            return (
                                                <div 
                                                    key={id} 
                                                    onClick={() => handleUnitClick(id)}
                                                    className={`unit-cell ${statusClass}`}
                                                >
                                                    {unit.price && unit.status === 'available' && (
                                                        <span className="price-text">{unit.price}</span>
                                                    )}
                                                    <span className="status-text">{label}</span>
                                                </div>
                                            );
                                        })}
                                    </div>
                                </div>
                            ))}
                        </div>

                        <div className="canvas-footer">
                            Generated by AI RealEstate
                        </div>
                    </div>

                    {/* DOWNLOAD BUTTON */}
                    <button 
                        onClick={handleDownloadImage}
                        className="mb-10 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-full shadow-lg flex items-center gap-2 transform transition hover:scale-105"
                    >
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>
                        ·Äì·Ä¨·Äê·Ä∫·Äï·ÄØ·Ä∂·Ä°·Äñ·Äº·ÄÖ·Ä∫ ·Äû·Ä≠·Äô·Ä∫·Ä∏·Äô·Ää·Ä∫
                    </button>
                    
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>