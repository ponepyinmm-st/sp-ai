<!DOCTYPE html>
<html lang="my">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Floor Plan Generator (Manual Price Edit)</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Myanmar:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Noto Sans Myanmar', sans-serif; background-color: #e5e7eb; }
        
        /* THE MAIN CANVAS (500x1350) - Fixed Ratio */
        .canvas-container {
            width: 500px;
            height: 1350px;
            background: white;
            margin: 0 auto;
            box-shadow: 0 0 20px rgba(0,0,0,0.2);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            border: 1px solid #ccc;
        }

        /* Header Area */
        .canvas-header {
            background-color: #b91c1c; /* Dark Red */
            color: white;
            padding: 25px;
            text-align: center;
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        /* Grid Body - Stretches to fill height */
        .grid-body {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 20px;
            background-color: #fff;
            justify-content: space-evenly; 
        }

        /* Each Floor Row */
        .floor-row {
            flex: 1; 
            display: flex;
            align-items: stretch;
            margin-bottom: 10px;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            overflow: hidden;
            max-height: 160px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .floor-label {
            width: 90px;
            background-color: #f1f5f9;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            color: #334155;
            font-size: 20px;
            border-right: 1px solid #cbd5e1;
        }

        .units-container {
            flex: 1;
            display: flex;
            padding: 8px;
            gap: 10px;
            background: white;
        }

        .unit-cell {
            flex: 1;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border: 3px solid; 
            transition: all 0.2s;
            position: relative;
        }

        /* STATUS COLORS */
        .status-available { border-color: #22c55e; background-color: #f0fdf4; color: #15803d; }
        .status-sold { border-color: #ef4444; background-color: #fee2e2; color: #ef4444; }
        .status-reserved { border-color: #eab308; background-color: #fef9c3; color: #854d0e; }
        
        /* Hidden but clickable for editing */
        .status-hidden { 
            border-color: #e5e7eb; 
            background-color: #f9fafb; 
            opacity: 0.4; 
            border-style: dashed;
        }

        .price-text {
            font-weight: 800;
            font-size: 18px;
            color: #b91c1c;
            background: white;
            padding: 4px 10px;
            border-radius: 6px;
            margin-bottom: 6px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .status-text {
            font-size: 16px;
            font-weight: 600;
        }
        
        /* Footer */
        .canvas-footer {
            padding: 15px;
            text-align: center;
            background: #f8fafc;
            color: #94a3b8;
            font-size: 12px;
            border-top: 1px solid #e2e8f0;
            flex-shrink: 0;
        }
    </style>
</head>
<body class="p-4 flex flex-col items-center">
    
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // --- Helper: Fetch ---
        async function fetchWithRetry(url, options, retries = 2, backoff = 1000) {
            try {
                const response = await fetch(url, options);
                if (!response.ok) {
                    const errorText = await response.text();
                    if (retries > 0) {
                        await new Promise(r => setTimeout(r, backoff));
                        return fetchWithRetry(url, options, retries - 1, backoff * 2);
                    }
                    throw new Error(`Server Error: ${response.status}`);
                }
                return response;
            } catch (err) {
                if (retries > 0) {
                    await new Promise(r => setTimeout(r, backoff));
                    return fetchWithRetry(url, options, retries - 1, backoff * 2);
                }
                throw err;
            }
        }

        const cleanJsonString = (str) => {
            if (!str) return '{}';
            try {
                const match = str.match(/\{[\s\S]*\}/);
                return match ? match[0] : str;
            } catch (e) { return str; }
        };

        function App() {
            const [chartImagePreview, setChartImagePreview] = useState(null);
            const [isAnalyzing, setIsAnalyzing] = useState(false);
            const [error, setError] = useState('');
            
            // UI Mode: 'status' or 'price'
            const [editMode, setEditMode] = useState('status');

            // Grid Data
            const [floorConfig, setFloorConfig] = useState({ floors: 6, unitsPerFloor: 2 });
            const [floorUnits, setFloorUnits] = useState({});

            // Initialize Grid
            useEffect(() => {
                const newUnits = {};
                for (let f = 1; f <= floorConfig.floors; f++) {
                    for (let u = 1; u <= floorConfig.unitsPerFloor; u++) {
                        const id = `${f}-${u}`;
                        if (floorUnits[id]) newUnits[id] = floorUnits[id];
                        else newUnits[id] = { id, floor: f, unit: u, status: 'available', price: '' };
                    }
                }
                setFloorUnits(newUnits);
            }, [floorConfig.floors, floorConfig.unitsPerFloor]);

            const handleChartUpload = async (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onloadend = async () => {
                        setChartImagePreview(reader.result);
                        await analyzeChartImage(reader.result);
                    };
                    reader.readAsDataURL(file);
                }
            };

            // HANDLE CLICK BASED ON MODE
            const handleUnitClick = (id) => {
                if (editMode === 'status') {
                    // Toggle Status
                    setFloorUnits(prev => {
                        const current = prev[id];
                        let nextStatus = 'sold';
                        if (current.status === 'available') nextStatus = 'sold';
                        else if (current.status === 'sold') nextStatus = 'reserved';
                        else if (current.status === 'reserved') nextStatus = 'hidden';
                        else if (current.status === 'hidden') nextStatus = 'available';
                        return { ...prev, [id]: { ...current, status: nextStatus }};
                    });
                } else {
                    // Edit Price
                    const currentUnit = floorUnits[id];
                    const newPrice = prompt("·Äà·Ä±·Ä∏·Äî·Äæ·ÄØ·Äî·Ä∫·Ä∏ ·Ä°·Äû·ÄÖ·Ä∫·Äë·Ää·Ä∑·Ä∫·Äï·Ä´ (·Ä•·Äï·Äô·Ä¨ - ·ÅÅ·ÅÖ·ÅÄ·ÅÄ):", currentUnit?.price || "");
                    if (newPrice !== null) {
                        setFloorUnits(prev => ({
                            ...prev,
                            [id]: { ...prev[id], price: newPrice }
                        }));
                    }
                }
            };

            const analyzeChartImage = async (base64Image) => {
                setIsAnalyzing(true);
                setError('');
                try {
                    const base64Content = base64Image.split(',')[1];
                    const mimeType = base64Image.substring(base64Image.indexOf(":") + 1, base64Image.indexOf(";"));
                    
                    const systemPrompt = `
                        Analyze floor plan. Extract GRID + PRICES.
                        Return JSON: { "floors": n, "unitsPerFloor": n, "units": [{"floor":n, "unit":n, "status":"sold"|"available"|"reserved"|"hidden", "price": "string"}] }
                        Rules:
                        1. Visual Stack: Bottom = Floor 1.
                        2. "X"/"Sold"/"Red" = "sold".
                        3. EXTRACT PRICES. If price exists, status is "available".
                        4. PENTHOUSE: If fewer units on top, mark as "hidden".
                    `;

                    const payload = {
                        contents: [{ parts: [{ text: systemPrompt }, { inlineData: { mimeType: mimeType, data: base64Content } }] }],
                        generationConfig: { responseMimeType: "application/json" }
                    };

                    const response = await fetchWithRetry('/api/generate', { 
                        method: 'POST', 
                        headers: { 'Content-Type': 'application/json' }, 
                        body: JSON.stringify(payload) 
                    });
                    
                    const data = await response.json();
                    if (!data.candidates) throw new Error("AI analysis failed.");
                    
                    const result = JSON.parse(cleanJsonString(data.candidates[0].content.parts[0].text));

                    if (result.floors) {
                        const finalUnitsPerFloor = result.unitsPerFloor || 1;
                        setFloorConfig({ floors: result.floors, unitsPerFloor: finalUnitsPerFloor });
                        
                        const newUnits = {};
                        for (let f = 1; f <= result.floors; f++) {
                            for (let u = 1; u <= finalUnitsPerFloor; u++) {
                                newUnits[`${f}-${u}`] = { id: `${f}-${u}`, floor: f, unit: u, status: 'available', price: '' };
                            }
                        }
                        if (result.units) {
                            result.units.forEach(u => {
                                let mapFloor = u.floor === 0 ? 1 : u.floor;
                                if (mapFloor > result.floors) mapFloor = result.floors;
                                const id = `${mapFloor}-${u.unit}`;
                                if (newUnits[id]) {
                                    newUnits[id].status = u.status;
                                    if (u.price) newUnits[id].price = u.price;
                                }
                            });
                        }
                        setFloorUnits(newUnits);
                    }
                } catch (err) { 
                    console.error(err); 
                    setError('Error: ' + err.message); 
                } 
                finally { setIsAnalyzing(false); }
            };

            const gridFloors = useMemo(() => {
                const floors = [];
                for(let f = floorConfig.floors; f >= 1; f--) floors.push(f);
                return floors;
            }, [floorConfig.floors]);

            return (
                <div className="flex flex-col gap-6 items-center w-full">
                    
                    {/* Controls */}
                    <div className="bg-white p-4 rounded-xl shadow w-full max-w-[500px] border border-gray-200 mt-4">
                        <h1 className="text-xl font-bold text-gray-800 mb-4 text-center">Floor Plan Auto-Generator</h1>
                        
                        {/* EDIT MODE TOGGLE */}
                        <div className="flex bg-gray-100 p-1 rounded-lg mb-4">
                            <button 
                                className={`flex-1 py-2 rounded-md text-sm font-bold transition-all ${editMode === 'status' ? 'bg-white shadow text-blue-600' : 'text-gray-500 hover:text-gray-700'}`}
                                onClick={() => setEditMode('status')}
                            >
                                üîÑ Status ·Äï·Äº·Ä±·Ä¨·ÄÑ·Ä∫·Ä∏·Äõ·Äî·Ä∫
                            </button>
                            <button 
                                className={`flex-1 py-2 rounded-md text-sm font-bold transition-all ${editMode === 'price' ? 'bg-white shadow text-red-600' : 'text-gray-500 hover:text-gray-700'}`}
                                onClick={() => setEditMode('price')}
                            >
                                ‚úèÔ∏è ·Äà·Ä±·Ä∏·Äî·Äæ·ÄØ·Äî·Ä∫·Ä∏·Äï·Äº·ÄÑ·Ä∫·Äõ·Äî·Ä∫
                            </button>
                        </div>

                         <label className="flex items-center justify-center w-full h-16 border-2 border-dashed border-blue-300 rounded-lg cursor-pointer hover:bg-blue-50 transition bg-gray-50 mb-4">
                            {isAnalyzing ? (
                                <div className="animate-pulse text-blue-600 font-bold text-sm">AI ·Äñ·Äê·Ä∫·Äî·Ä±·Äï·Ä´·Äû·Ää·Ä∫...</div>
                            ) : (
                                chartImagePreview ? <div className="text-green-600 font-bold text-sm">Image Loaded</div> : <span className="text-gray-400 text-sm font-bold">Screenshot ·Äê·ÄÑ·Ä∫·Äõ·Äî·Ä∫</span>
                            )}
                            <input type="file" className="hidden" accept="image/*" onChange={handleChartUpload} disabled={isAnalyzing} />
                        </label>

                         <div className="flex gap-4">
                            <div className="w-1/2">
                                <label className="text-[10px] text-gray-400 uppercase font-bold">·Ä°·Äë·Äï·Ä∫</label>
                                <input type="number" value={floorConfig.floors} onChange={(e) => setFloorConfig({...floorConfig, floors: +e.target.value})} className="w-full border p-2 rounded text-sm" />
                            </div>
                            <div className="w-1/2">
                                <label className="text-[10px] text-gray-400 uppercase font-bold">·Ä°·ÄÅ·Äî·Ä∫·Ä∏</label>
                                <input type="number" value={floorConfig.unitsPerFloor} onChange={(e) => setFloorConfig({...floorConfig, unitsPerFloor: +e.target.value})} className="w-full border p-2 rounded text-sm" />
                            </div>
                        </div>
                        {error && <div className="mt-2 text-red-600 text-xs">{error}</div>}
                    </div>

                    {/* --- CANVAS 500x1350 --- */}
                    <div className="canvas-container">
                        <div className="canvas-header">
                            <h2 className="text-3xl font-bold tracking-wide uppercase">Floor Plan & Prices</h2>
                        </div>
                        
                        <div className="grid-body">
                            {gridFloors.map(f => (
                                <div key={f} className="floor-row">
                                    <div className="floor-label">{f} ·Äú·ÄΩ·Äæ·Ä¨</div>
                                    <div className="units-container">
                                        {Array.from({length: floorConfig.unitsPerFloor}).map((_, i) => {
                                            const u = i + 1;
                                            const id = `${f}-${u}`;
                                            const unit = floorUnits[id] || {status: 'available'};
                                            
                                            let statusClass = 'status-available';
                                            let label = '·Äõ·Ä±·Ä¨·ÄÑ·Ä∫·Ä∏·Äõ·Äî·Ä∫';
                                            
                                            if (unit.status === 'sold') { 
                                                statusClass = 'status-sold'; 
                                                label = '·Äõ·Ä±·Ä¨·ÄÑ·Ä∫·Ä∏·Äï·Äº·ÄÆ·Ä∏'; 
                                            }
                                            else if (unit.status === 'reserved') { 
                                                statusClass = 'status-reserved'; 
                                                label = '·ÄÖ·Ä¨·Äõ·ÄÑ·Ä∫·Ä∏·Äû·ÄΩ·ÄÑ·Ä∫·Ä∏'; 
                                            }
                                            else if (unit.status === 'hidden') { 
                                                statusClass = 'status-hidden'; 
                                                label = ''; 
                                            }

                                            return (
                                                <div 
                                                    key={id} 
                                                    onClick={() => handleUnitClick(id)}
                                                    className={`unit-cell ${statusClass}`}
                                                >
                                                    {unit.price && unit.status === 'available' && (
                                                        <span className="price-text">{unit.price}</span>
                                                    )}
                                                    <span className="status-text">{label}</span>
                                                </div>
                                            );
                                        })}
                                    </div>
                                </div>
                            ))}
                        </div>

                        <div className="canvas-footer">
                            Generated by AI RealEstate
                        </div>
                    </div>
                    
                    <p className="text-gray-400 text-xs mb-10">Screenshot ·Äõ·Ä≠·ÄØ·ÄÄ·Ä∫·Äõ·Äî·Ä∫ ·Ä°·ÄÜ·ÄÑ·Ä∫·Äû·ÄÑ·Ä∑·Ä∫·Äñ·Äº·ÄÖ·Ä∫·Äï·Ä´·Äï·Äº·ÄÆ</p>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>